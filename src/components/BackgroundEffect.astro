<!-- Circuit Board Background Pattern -->
<svg id="circuit-pattern" aria-hidden="true">
	<defs>
		<pattern id="circuit-grid" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
			<!-- Horizontal lines -->
			<line x1="0" y1="20" x2="100" y2="20" stroke="#1e3a5f" stroke-width="0.5" opacity="0.3"/>
			<line x1="0" y1="50" x2="100" y2="50" stroke="#1e3a5f" stroke-width="0.5" opacity="0.3"/>
			<line x1="0" y1="80" x2="100" y2="80" stroke="#1e3a5f" stroke-width="0.5" opacity="0.3"/>
			
			<!-- Vertical lines -->
			<line x1="20" y1="0" x2="20" y2="100" stroke="#1e3a5f" stroke-width="0.5" opacity="0.3"/>
			<line x1="50" y1="0" x2="50" y2="100" stroke="#1e3a5f" stroke-width="0.5" opacity="0.3"/>
			<line x1="80" y1="0" x2="80" y2="100" stroke="#1e3a5f" stroke-width="0.5" opacity="0.3"/>
			
			<!-- Circuit nodes -->
			<circle cx="20" cy="20" r="2" fill="#2563eb" opacity="0.4"/>
			<circle cx="50" cy="50" r="2" fill="#2563eb" opacity="0.4"/>
			<circle cx="80" cy="80" r="2" fill="#2563eb" opacity="0.4"/>
			<circle cx="80" cy="20" r="2" fill="#2563eb" opacity="0.4"/>
			<circle cx="20" cy="80" r="2" fill="#2563eb" opacity="0.4"/>
			
			<!-- Diagonal connection lines -->
			<line x1="20" y1="20" x2="35" y2="35" stroke="#1e3a5f" stroke-width="0.5" opacity="0.2"/>
			<line x1="65" y1="65" x2="80" y2="80" stroke="#1e3a5f" stroke-width="0.5" opacity="0.2"/>
		</pattern>
	</defs>
	<rect width="100%" height="100%" fill="url(#circuit-grid)"/>
</svg>

<div id='bg-grid' aria-hidden='true'>
	{new Array(25).fill(<div />)}
</div>

<script lang='javascript'>
	const grid = document.getElementById('bg-grid')
	const [ rows, columns ] = [ 5, 5 ]

	let lastHovered = -1
	let mouseDown = false
	let lastHue = 0
	const prevDown = {}

	const render = (event) => {
		const [ x, y ] = [ event.clientX, event.clientY ]
		const row = Math.floor(y * rows / window.innerHeight)
		const column = Math.floor(x * columns / window.innerWidth)

		const cellIndex = row < rows || column > columns
			? row * rows + column
			: -1
		const hovered = grid.children[cellIndex]

		if (cellIndex >= 0) {
			if (!prevDown[cellIndex] && (mouseDown || window.rainbowMode)) {
				const hue = (lastHue + 12 + Math.floor(Math.random() * 16)) % 360
				hovered.style.setProperty('--click-bg', `hsl(${hue}deg, 100%, 50%, 0.5)`)
				lastHue = hue
			}

			hovered.classList.add('hovered')
			hovered.classList.toggle('clicked', (mouseDown || window.rainbowMode))
			hovered.classList.toggle('hovered-fast-trans', !prevDown[cellIndex] && !(mouseDown || window.rainbowMode))
		}
		
		if (lastHovered >= 0 && lastHovered !== cellIndex) {
			grid.children[lastHovered].classList.remove('hovered', 'hovered-fast-trans', 'clicked')
			prevDown[lastHovered] = false
		}
		
		lastHovered = cellIndex
		prevDown[cellIndex] = mouseDown || window.rainbowMode
	}

	document.addEventListener('mousemove', render, { capture: true, passive: true })
	document.addEventListener('mouseleave', () => render({ clientX: -1, clientY: -1 }), { passive: true })
	document.addEventListener('mousedown', (event) => { mouseDown = true; render(event) }, { capture: true, passive: true })
	document.addEventListener('mouseup', (event) => { mouseDown = false; render(event) }, { capture: true, passive: true })
	document.addEventListener('dragend', (event) => { mouseDown = false; render(event) }, { capture: true, passive: true })
</script>

<style>
	#circuit-pattern {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		z-index: -3;
		pointer-events: none;
		opacity: 0.6;
	}

	#bg-grid {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		display: grid;
		z-index: -2;
		pointer-events: none;
		filter: blur(8px);
		grid-template-columns: repeat(5, 1fr);
		transform: scale(1.05);
	}

	#bg-grid div {
		background: transparent;
		transition: 800ms background linear;

		&.hovered {
			background: rgba(30, 58, 95, 0.15);
		}

		&.hovered-fast-trans {
			transition: 100ms background linear;
		}

		&.clicked {
			background: var(--click-bg);
			transition: 10ms background linear;
		}
	}
</style>
